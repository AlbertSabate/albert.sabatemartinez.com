name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  code-quality:
    name: ğŸ” Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: ğŸ—ï¸ Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-
        
      - name: ğŸ“¥ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          bun install --frozen-lockfile
          echo "âœ… Dependencies installed successfully!"
        
      - name: ğŸ¨ Format Check
        run: |
          echo "ğŸ¨ Checking code formatting..."
          bun run format:check
          echo "âœ… Code formatting looks good!"
        
      - name: ğŸ” Lint Code
        run: |
          echo "ğŸ” Running linter..."
          bun run lint
          echo "âœ… No linting errors found!"
        
      - name: ğŸ”§ Type Check
        run: |
          echo "ğŸ”§ Checking TypeScript types..."
          bun run typecheck
          echo "âœ… TypeScript compilation successful!"

  deploy-production:
    name: ğŸš€ Deploy to Production
    needs: code-quality
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://albert.sabatemartinez.com
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
        
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          
      - name: ğŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile
        
      - name: ğŸ”¨ Build Application
        run: |
          echo "ğŸ”¨ Building application..."
          bun run build
          echo "âœ… Build completed successfully!"
          
      - name: ğŸŒ Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸ‰ Successfully deployed to production!"
          echo "ğŸŒ Site is live at: https://albert.sabatemartinez.com"

  deploy-preview:
    name: ğŸ‘ï¸ Deploy Preview
    needs: code-quality
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment:
      name: preview
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Setup Bun Runtime
        uses: oven-sh/setup-bun@v2
        
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          
      - name: ğŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile
        
      - name: ğŸ”¨ Build Application
        run: |
          echo "ğŸ”¨ Building application..."
          bun run build
          echo "âœ… Build completed successfully!"
          
      - name: ğŸ‘ï¸ Deploy Preview to Cloudflare
        id: preview-deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env preview
          
      - name: ğŸ’¬ Comment Preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.preview-deploy.outputs.deployment-url }}';
            const shortSha = '${{ github.sha }}'.substring(0, 7);
            const comment = `## ğŸš€ Preview Deployment Ready!
            
            Your changes have been deployed to a preview environment:
            
            ğŸ”— **Preview URL:** ${url}
            
            ### ğŸ“‹ Deployment Details
            - **Commit:** \`${shortSha}\`
            - **Branch:** \`${{ github.head_ref }}\`
            - **Triggered by:** @${{ github.actor }}
            
            ---
            
            This preview will be automatically updated as you push new commits to this PR.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });